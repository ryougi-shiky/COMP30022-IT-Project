#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")/.."

echo "-------------------- ðŸ§ª Running E2E Tests --------------------"

APP_URL=$1

# Ensure the URL starts with http:// or https://
if [[ ! "$APP_URL" =~ ^https?:// ]]; then
  APP_URL="http://${APP_URL}"
fi

echo "APP_URL=${APP_URL}"

cd frontend
docker rm -f cypress-e2e || true

# Run tests in sequence: register -> login -> home -> profile
TEST_FILES=(
    "register.cy.js"
    "login.cy.js"
    "home.cy.js"
    "profile.cy.js"
)

# Higher timeout values for remote deployments (AWS ECS)
# These account for network latency and cold starts
CYPRESS_DEFAULT_COMMAND_TIMEOUT=15000
CYPRESS_RESPONSE_TIMEOUT=60000
CYPRESS_RETRIES=2

for test_file in "${TEST_FILES[@]}"; do
    echo "Running test: $test_file"
    docker run --rm --name cypress-e2e --network=host \
        -v "$(pwd)/cypress/screenshots:/app/cypress/screenshots" \
        -v "$(pwd)/cypress/fixtures:/app/cypress/fixtures" \
        -e CYPRESS_BASE_URL=${APP_URL} \
        -e CYPRESS_DEFAULT_COMMAND_TIMEOUT=${CYPRESS_DEFAULT_COMMAND_TIMEOUT} \
        -e CYPRESS_RESPONSE_TIMEOUT=${CYPRESS_RESPONSE_TIMEOUT} \
        -e CYPRESS_RETRIES=${CYPRESS_RETRIES} \
        frontend-dev npx cypress run --spec "cypress/e2e/$test_file"
done
