#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")/.."

if [[ -z "${GITHUB_EVENT_PATH:-}" || -z "${GITHUB_REPOSITORY:-}" || -z "${GITHUB_TOKEN:-}" ]]; then
  echo "Missing required GitHub Actions environment variables."
  exit 1
fi

pr_body=$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")
pr_number=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")

if [[ -z "$pr_body" || -z "$pr_number" ]]; then
  echo "No PR body or PR number found in event payload."
  exit 0
fi

labels=$(echo "$pr_body" | grep -iE '^\s*-\s*\[x\]\s*/kind ' | sed -E 's/.*\/kind ([^ ]+).*/kind\/\1/')

if [[ -z "$labels" ]]; then
  echo "No kind labels found."
  exit 0
fi

owner=$(echo "$GITHUB_REPOSITORY" | cut -d/ -f1)
repo=$(echo "$GITHUB_REPOSITORY" | cut -d/ -f2)
labels_json=$(printf '%s\n' $labels | jq -R . | jq -s .)

curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  "https://api.github.com/repos/$owner/$repo/issues/$pr_number/labels" \
  -d "{\"labels\":$labels_json}"
