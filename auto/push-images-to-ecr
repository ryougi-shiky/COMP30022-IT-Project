#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")/.."

echo "-------------------- üôå Push Docker Images to ECR --------------------"
echo "-------------------- üîê Login AWS Public ECR --------------------"
aws ecr-public get-login-password --region us-east-1 | \
docker login --username AWS --password-stdin public.ecr.aws

VERSION=latest
DOCKER_USER=localuser

echo "-------------------- ‚öíÔ∏è Building Images --------------------"

auto/build $DOCKER_USER ${VERSION}

echo "-------------------- üè∑Ô∏è Tagging Images --------------------"

docker tag $DOCKER_USER/forum-backend:${VERSION} public.ecr.aws/g0n3r5g7/comp30022-forum/backend:${VERSION}
docker tag $DOCKER_USER/forum-mongodb:${VERSION} public.ecr.aws/g0n3r5g7/comp30022-forum/mongodb:${VERSION}
docker tag $DOCKER_USER/forum-nginx:${VERSION} public.ecr.aws/g0n3r5g7/comp30022-forum/nginx:${VERSION}

echo "-------------------- üöÄ Pushing Images to ECR --------------------"
docker push public.ecr.aws/g0n3r5g7/comp30022-forum/backend:${VERSION}
docker push public.ecr.aws/g0n3r5g7/comp30022-forum/mongodb:${VERSION}
docker push public.ecr.aws/g0n3r5g7/comp30022-forum/nginx:${VERSION}
