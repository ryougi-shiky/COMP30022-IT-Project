version: "3.9"
services:

  server:
    container_name: server
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    ports:
      - "17000:17000"
    environment:
      MONGODB_URI: "mongodb://mongodb:27018"
      MONGODB_NAME: "ani"
      NODE_ENV: "development"
      PORT: "17000"
      CORS_WHITELIST: "http://localhost:3000,http://localhost:17000,http://server"
    depends_on:
      - mongodb
    networks:
      - app-network

  mongodb:
    image: mongo:6.0.4
    container_name: mongodb
    ports:
      - "27018:27018"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=ani
    command: [ "mongod", "--port", "27018" ]
    restart: always
    networks:
      - app-network

  mongo-seed:
    image: mongo:6.0.4
    depends_on:
      - mongodb
    volumes:
      - ./db/mongo/dump:/dump
    entrypoint: [ "sh", "-c", "sleep 5 && mongorestore --host mongodb --port 27018 --db ani /dump/ani" ]
    networks:
      - app-network

  nginx:
    build:
      context: .
      dockerfile: ./nginx/Dockerfile.dev
    depends_on:
      - server
    ports:
      - "3000:3000"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mongodb_data:
